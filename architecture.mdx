---
title: Architecture
description: "CQRS event-driven architecture for multi-chain identity"
---

# Architecture

Signum implements a **CQRS (Command Query Responsibility Segregation)** pattern with Kafka-based event-driven architecture for reliable multi-chain identity management.

## CQRS Overview

The architecture separates write operations (commands) from read operations (queries):

| Operation | HTTP Response | Behavior |
|-----------|---------------|----------|
| **Commands** | `202 Accepted` | Writes to DB, publishes Kafka command, async on-chain execution |
| **Queries** | `200 OK` | Reads directly from database (eventually consistent) |

```mermaid
flowchart LR
    subgraph client [Client Application]
        App[Web/Mobile App]
    end

    subgraph api [Signum API]
        Commands[Command Handlers]
        Queries[Query Handlers]
    end

    subgraph storage [Storage]
        DB[(Supabase)]
        Kafka[Kafka]
    end

    subgraph workers [Infrastructure Workers]
        AttWorker[attestation-worker]
        TransWorker[transfer-worker]
        WalletWorker[wallet-worker]
        DbSync[db-sync-worker]
    end

    App -->|"POST /attestations"| Commands
    App -->|"GET /attestations"| Queries
    
    Commands -->|Write pending| DB
    Commands -->|Publish command| Kafka
    Commands -->|"202 Accepted"| App
    
    Queries -->|Read| DB
    Queries -->|"200 OK"| App
    
    Kafka --> AttWorker
    Kafka --> TransWorker
    Kafka --> WalletWorker
    AttWorker --> DbSync
    TransWorker --> DbSync
    WalletWorker --> DbSync
    DbSync -->|Update status| DB
```

## System Architecture

```mermaid
flowchart TB
    subgraph SignumAPI ["Signum Identity Provider"]
        subgraph APILayer ["API Layer (Elysia/Bun)"]
            OAuth["OAuth2/OIDC"]
            DirectAuth["Direct Auth"]
            Attestations["Attestations<br/>(CQRS)"]
            Accounts["Accounts"]
            Solana["Solana API"]
        end

        subgraph CommandBus ["Command Bus (Kafka)"]
            AttCmd["signum.attestation.commands"]
            TransCmd["signum.transfer.commands"]
            WalletCmd["signum.wallet.commands"]
        end

        subgraph Storage ["Storage Layer"]
            Postgres[("PostgreSQL<br/>(Supabase)")]
            Dragonfly[("Dragonfly<br/>(Redis)")]
            InMemory[("In-Memory<br/>JWKS Cache")]
        end
    end

    subgraph Workers ["Infrastructure Workers"]
        KycProc["kyc-processor"]
        AttWorker["attestation-worker"]
        TransWorker["transfer-worker"]
        WalletWorker["wallet-worker"]
        DbSync["db-sync-worker"]
        SolListener["solana-listener"]
    end

    subgraph Chains ["Blockchain Networks"]
        SolanaChain["Solana<br/>(Active)"]
        EVMChain["EVM Chains<br/>(Planned)"]
        ARCChain["ARC/Circle<br/>(Planned)"]
        ArchChain["Arch/Bitcoin<br/>(Planned)"]
    end

    OAuth --> Postgres
    DirectAuth --> Postgres
    Attestations --> AttCmd
    Attestations --> Postgres
    Accounts --> WalletCmd
    Solana --> WalletCmd

    AttCmd --> AttWorker
    TransCmd --> TransWorker
    WalletCmd --> WalletWorker

    AttWorker --> SolanaChain
    TransWorker --> SolanaChain
    WalletWorker --> SolanaChain

    SolanaChain --> SolListener
    SolListener --> DbSync
    AttWorker --> DbSync
    TransWorker --> DbSync
    WalletWorker --> DbSync
    DbSync --> Postgres
```

## Core Components

### API Layer

The API is built with **Elysia** on the **Bun** runtime for maximum performance:

| Endpoint Group | Purpose | Pattern |
|----------------|---------|---------|
| `/auth/*` | Direct API authentication | Sync (200) |
| `/oauth/*` | OAuth2/OIDC flows | Sync (200) |
| `/accounts/*` | Chain identity management | Sync (200) |
| `/solana/wallets` | PDA wallet creation | **Async (202)** |
| `/attestations` | KYC attestation management | **Async (202)** |
| `/kyc/*` | KYC verification status | Sync (200) |
| `/.well-known/*` | OIDC discovery and JWKS | Sync (200) |

### Command Endpoints (202 Accepted)

These endpoints queue operations for async processing:

| Endpoint | Command Topic | Worker |
|----------|---------------|--------|
| `POST /solana/wallets` | `signum.wallet.commands` | wallet-worker |
| `POST /attestations` | `signum.attestation.commands` | attestation-worker |
| `DELETE /attestations/:id` | `signum.attestation.commands` | attestation-worker |
| `POST /transfers` | `signum.transfer.commands` | transfer-worker |

### Query Endpoints (200 OK)

These endpoints read directly from the database:

| Endpoint | Description |
|----------|-------------|
| `GET /accounts` | List all chain identities |
| `GET /accounts/wallets` | Get embedded wallets |
| `GET /solana/status` | Get Solana wallet status |
| `GET /attestations` | List user's attestations |
| `GET /attestations/:id` | Get attestation by ID |

## Worker Services

```mermaid
flowchart LR
    subgraph Commands ["Command Topics"]
        A1["signum.attestation.commands"]
        T1["signum.transfer.commands"]
        W1["signum.wallet.commands"]
    end

    subgraph Workers ["Workers"]
        AW["attestation-worker"]
        TW["transfer-worker"]
        WW["wallet-worker"]
    end

    subgraph Events ["Event Topics"]
        E1["signum.blockchain.events"]
    end

    subgraph Sync ["Database Sync"]
        DS["db-sync-worker"]
        DB[(Supabase)]
    end

    A1 --> AW
    T1 --> TW
    W1 --> WW

    AW --> E1
    TW --> E1
    WW --> E1

    E1 --> DS
    DS --> DB
```

| Worker | Input | Output | Responsibility |
|--------|-------|--------|----------------|
| **kyc-processor** | KYC webhooks | `signum.kyc.status.changed` | Process KYC provider webhooks |
| **attestation-worker** | `signum.attestation.commands` | `signum.blockchain.events` | Create/revoke on-chain attestations |
| **transfer-worker** | `signum.transfer.commands` | `signum.blockchain.events` | Execute compliant token transfers |
| **wallet-worker** | `signum.wallet.commands` | `signum.blockchain.events` | Initialize PDA wallets on-chain |
| **db-sync-worker** | All event topics | Database writes | Sync blockchain state to database |
| **solana-listener** | Helius webhooks | `chain.solana.events` | Monitor on-chain account changes |

## Event Flow Examples

### KYC to On-Chain Attestation

```mermaid
sequenceDiagram
    participant Provider as KYC Provider
    participant KycProc as kyc-processor
    participant Kafka
    participant AttWorker as attestation-worker
    participant Solana
    participant DbSync as db-sync-worker
    participant DB as Supabase

    Provider->>KycProc: POST /webhook/sumsub
    KycProc->>Kafka: signum.kyc.status.changed
    
    Kafka->>DbSync: Consume KYC event
    DbSync->>DB: Update kyc_verifications
    
    Note over AttWorker: API triggers attestation
    
    Kafka->>AttWorker: signum.attestation.commands
    AttWorker->>Solana: Create attestation PDA
    AttWorker->>Kafka: signum.blockchain.events
    
    Kafka->>DbSync: Consume blockchain event
    DbSync->>DB: Update attestation status â†’ confirmed
```

### Wallet PDA Initialization

```mermaid
sequenceDiagram
    participant App as Client App
    participant API as Signum API
    participant DB as Supabase
    participant Kafka
    participant Worker as wallet-worker
    participant Solana

    App->>API: POST /solana/wallets
    API->>DB: Insert wallet (status: pending)
    API->>Kafka: signum.wallet.commands
    API-->>App: 202 Accepted {walletId, status: pending}
    
    Kafka->>Worker: Consume CREATE_WALLET_PDA
    Worker->>Solana: Initialize PDA account
    Worker->>Kafka: signum.blockchain.events
    
    Note over DB: db-sync-worker updates status
    
    App->>API: GET /solana/status
    API->>DB: Query wallet status
    API-->>App: 200 OK {status: confirmed}
```

## Infrastructure

### Kafka Topics

| Topic | Producer | Consumer | Purpose |
|-------|----------|----------|---------|
| `signum.kyc.status.changed` | kyc-processor | db-sync-worker | KYC verification updates |
| `signum.attestation.commands` | Signum API | attestation-worker | Create/revoke attestations |
| `signum.transfer.commands` | Signum API | transfer-worker | Execute compliant transfers |
| `signum.wallet.commands` | Signum API | wallet-worker | Initialize PDA wallets |
| `signum.blockchain.events` | All workers | db-sync-worker | Confirmed/failed tx events |
| `chain.solana.events` | solana-listener | db-sync-worker | On-chain account changes |

### Dragonfly (Cache)

High-performance Redis-compatible cache:

| Use Case | Key Pattern | TTL |
|----------|-------------|-----|
| Rate limiting | `ratelimit:{endpoint}:{ip}` | Window size |
| Authorization codes | `auth_code:{code}` | 10 minutes |
| Token revocation | `revoked:{jti}` | Token expiry |
| OAuth state | `oauth_state:{state}` | 15 minutes |
| JWKS cache | `jwks:current` | 1 hour |

### Supabase (Database)

PostgreSQL with Row-Level Security:

```sql
-- Core tables
users                    -- User accounts
user_chain_identities    -- Linked wallet addresses
kyc_verifications        -- KYC status and metadata
solana_wallets           -- PDA wallet records with status
solana_attestations      -- Attestation records with status
oauth_clients            -- Registered applications
refresh_tokens           -- Token storage
```

## Chain Integration Roadmap

```mermaid
flowchart LR
    subgraph Active ["Active"]
        Solana["Solana<br/>Token-2022, PDAs<br/>via Helius"]
    end

    subgraph Next ["Next Priority"]
        EVM["EVM/Ethereum<br/>ERC-3643<br/>Multi-chain"]
    end

    subgraph Planned ["Planned"]
        ARC["ARC<br/>Circle USDC<br/>Chain"]
        Arch["Arch<br/>Bitcoin<br/>Layer"]
    end

    Active --> Next --> Planned
```

| Priority | Chain | Status | Technology |
|----------|-------|--------|------------|
| 1 | **Solana** | Active | Token-2022, Transfer Hooks, PDAs via Helius |
| 2 | **EVM/Ethereum** | Next | ERC-3643 Identity Registry (Ethereum, Polygon, Base) |
| 3 | **ARC** | Planned | Circle USDC chain integration |
| 4 | **Arch** | Planned | Bitcoin layer integration |

### Solana via Helius

[Helius](https://helius.dev) provides enhanced Solana RPC:

- **WebSocket streaming** for real-time PDA monitoring
- **Priority Fee API** for reliable transaction landing
- **Enhanced RPC** for complex queries

The **solana-listener** service monitors PDAs and publishes events to Kafka.

### EVM (Planned)

Multi-chain EVM support using viem:

| Network | Chain ID | Status |
|---------|----------|--------|
| Ethereum Mainnet | 1 | Planned |
| Polygon | 137 | Planned |
| Base | 8453 | Planned |
| Arbitrum One | 42161 | Planned |

## Security Architecture

### Authentication Flow

```mermaid
sequenceDiagram
    participant Client
    participant Signum as Signum API
    participant Cache as Dragonfly
    participant DB as Database

    Client->>Signum: POST /auth/login
    Signum->>DB: Verify credentials
    DB-->>Signum: User data
    Signum->>Signum: Sign JWT (ES256)
    Signum->>Cache: Store refresh token
    Signum->>Client: Access + Refresh tokens
    
    Note over Client,Signum: Later...
    
    Client->>Signum: GET /api with Bearer token
    Signum->>Cache: Check revocation
    Cache-->>Signum: Not revoked
    Signum->>Signum: Verify JWT signature
    Signum->>Client: Protected resource
```

### Token Security

| Token Type | Lifetime | Storage | Rotation |
|------------|----------|---------|----------|
| Access Token | 1 hour | Client memory | On expiry |
| Refresh Token | 30 days | Secure cookie | Per use |
| ID Token | 1 hour | Client memory | With access |

### Rate Limiting

Sliding window rate limiting via Dragonfly:

| Endpoint | Anonymous | Authenticated |
|----------|-----------|---------------|
| `/auth/*` | 10/min | 100/min |
| `/oauth/*` | 50/min | 500/min |
| `/api/*` | 100/min | 1000/min |

## Deployment

### Development

```bash
# Start infrastructure
cd infra && make start-all

# Runs:
# - Supabase (localhost:54321)
# - Dragonfly (localhost:6379)
# - Redpanda (localhost:9092)

# Start API
cd ../app && bun dev
```

### Production

| Component | Platform | Scaling |
|-----------|----------|---------|
| API | Fly.io / Railway | Horizontal |
| Workers | Docker / Kubernetes | Per topic |
| Cache | Dragonfly Cloud | Single node |
| Database | Supabase Cloud | Managed |
| Events | Confluent Cloud | Managed |
